import os
import firebase_admin
from firebase_admin import credentials, firestore
from flask import Flask, render_template, request, jsonify

app = Flask(__name__)

# --- DATABASE CONNECTION ---
# Render par file check karein
if os.path.exists('firebase_key.json'):
    cred = credentials.Certificate('firebase_key.json')
    firebase_admin.initialize_app(cred)
    db = firestore.client()
    print("✅ Live Database Connected!")
else:
    print("⚠️ Error: Key File Missing!")

# --- PAGES ---
@app.route('/')
def home():
    return render_template('index.html')

# --- API: SAVE SCORE ---
@app.route('/api/save_score', methods=['POST'])
def save_score():
    try:
        data = request.json
        user_id = str(data.get('user_id'))
        new_score = data.get('score')
        
        # Firestore mein save karein
        user_ref = db.collection('users').document(user_id)
        user_ref.set({
            'score': new_score,
            'last_active': firestore.SERVER_TIMESTAMP
        }, merge=True)
        
        return jsonify({"status": "success", "message": "Saved to Firebase"})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)})

# --- API: LEADERBOARD ---
@app.route('/api/leaderboard', methods=['GET'])
def get_leaderboard():
    try:
        users_ref = db.collection('users')
        query = users_ref.order_by('score', direction=firestore.Query.DESCENDING).limit(10)
        results = query.stream()
        
        leaderboard = []
        for doc in results:
            data = doc.to_dict()
            leaderboard.append({
                "name": "Player", # Baad mein asli naam lagayenge
                "score": data.get('score', 0)
            })
        return jsonify(leaderboard)
    except Exception as e:
        return jsonify([])

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
